<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Air 5T4R</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/5.0/examples/headers/">

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
      .logo-img {
        width: 80px;
        height: 64px;
      }
      .nav-link {
        margin-right: 15px; /* 항목 간의 간격 조정 */
        font-family: Arial, sans-serif; /* 글꼴 변경 */
        font-size: 1rem; /* 글꼴 크기 변경 */
        font-weight: bold;
      }
      .nav-link:last-child {
        margin-right: 0; /* 마지막 항목의 오른쪽 여백 제거 */
      }

      /* 로그인 버튼 스타일 */
      .btn-outline-primary-custom {
        color: #000000;
        background-color: #ffffff;
        border: none;
        font-family: 'Arial', sans-serif;
        font-weight: bold;
      }

      .btn-outline-primary-custom:hover {
        color: #fff;
        background-color: #a5cdf7;
        border: none;
      }

      /* 회원가입 버튼 스타일 */
      .btn-primary-custom {
        color: #000000;
        background-color: #ffffff;
        border: none;
        font-family: 'Arial', sans-serif;
        font-weight: bold;
      }

      .btn-primary-custom:hover {
        color: #fff;
        background-color: #a5cdf7;
        border: none;
      }

      body, html {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      main {
        flex: 1;
      }
      footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
      }
      .dropdown-menu {
        max-height: 200px;
        overflow-y: auto;
      }
      .form-section {
        margin: 20px 0;
      }
      .custom-container {
        max-width: 1000px;
        }
        h2 {
            font-family: 'Arial', sans-serif;
            font-size: 20px;
            font-weight: bold;
            color: #000000;
        }
        h5{
            font-family: Arial, Helvetica, sans-serif;
            font-size: 16px;
            font-weight: bold;
        }
    
   
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Load header
        fetch("/header.html")
            .then(response => response.text())
            .then(data => {
                document.getElementById("header").innerHTML = data;
                const script = document.createElement('script');
                script.text = "checkSession();";
                document.body.appendChild(script);
            })
            .catch(error => console.error("Error loading header:", error));
            
        // Load footer
        fetch("footer.html")
          .then(response => response.text())
          .then(data => {
            document.getElementById("footer").innerHTML = data;
          })
          .catch(error => console.error("Error loading footer:", error));

      });
    </script>
  </head>
  <body>

    <div id="header"></div>

    <main id="main-container">
      <div class="container">
        <div class="container mt-4 custom-container">
            <h2 class="mb-3">여행자 정보입력</h2>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">예약 정보</h5>
                    <form>
                        <input type="hidden" id="id">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="departureAirport">출발 공항</label>
                                <input type="text" id="departureAirport" class="form-control" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="arrivalAirport">도착 공항</label>
                                <input type="text" id="arrivalAirport" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="departureTime">출발 시간</label>
                                <input type="text" id="departureTime" class="form-control" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="arrivalTime">도착 시간</label>
                                <input type="text" id="arrivalTime" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="flightNumber">편명</label>
                                <input type="text" id="flightNumber" class="form-control" disabled>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="price">가격</label>
                                <input type="text" id="price" class="form-control" disabled>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="passengers">인원</label>
                                <input type="text" id="passengers" class="form-control" disabled>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">예매자 정보입력</h5>
                    <form>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">영문이름</label>
                                <input type="text" class="form-control" id="FirstName" placeholder="여권에 표시된 영문 이름 입력">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">영문성</label>
                                <input type="text" class="form-control" id="LastName" placeholder="여권에 표시된 영문 성 입력">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">이메일</label>
                                <input type="email" class="form-control" id="email" placeholder="이메일 주소" disabled>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="phone" placeholder="전화번호" disabled>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="passengerInfoContainer"></div>

            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-primary" type="button">예약 완료</button>
            </div>
        </div>
      </div>
    </main>

    <div id="footer"></div>

  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLabel">예약 성공</h5>
        </div>
        <div class="modal-body">
          에약 정보와 탑승자 정보가 확인되었습니다. 결제 방법을 확인하고 예약 확정을 받으세요!
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="confirmBtn">Confirm</button>
        </div>
      </div>
    </div>
  </div>

    <script>
        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (decodeURIComponent(pair[0]) === variable) {
                    return decodeURIComponent(pair[1].replace(/\+/g, ' '));
                }
            }
            return false;
        }

        document.getElementById('id').value = getQueryVariable('id');
        document.getElementById('departureAirport').value = getQueryVariable('departure');
        document.getElementById('arrivalAirport').value = getQueryVariable('destination');
        document.getElementById('departureTime').value = getQueryVariable('departureTime');
        document.getElementById('arrivalTime').value = getQueryVariable('arrivalTime');
        document.getElementById('flightNumber').value = getQueryVariable('flightNumber');
        document.getElementById('price').value = getQueryVariable('price');
        document.getElementById('passengers').value = getQueryVariable('passengers');

    
        document.addEventListener('DOMContentLoaded', function() {
        const passengerCount = parseInt(getQueryVariable('passengers'), 10);
        const container = document.getElementById('passengerInfoContainer');
        
        let priceText = document.getElementById('price').value;
        let price = parseFloat(priceText.replace(/,/g, '')); // 쉼표 제거 후 숫자 변환
        let totalPrice = price * passengerCount; // 총 가격 계산
        document.getElementById('price').value = totalPrice.toLocaleString(); // 결과를 쉼표 포함 형식으로 다시 변환


        for (let i = 1; i <= passengerCount; i++) {
            const div = document.createElement('div');
            div.innerHTML = `
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">탑승자 ${i}</h5>
                        <div class="mb-3">
                            <label for="firstName${i}" class="form-label">영문이름</label>
                            <input type="text" class="form-control" id="firstName${i}" placeholder="여권에 표시된 영문 이름 입력">
                        </div>
                        <div class="mb-3">
                            <label for="lastName${i}" class="form-label">영문성</label>
                            <input type="text" class="form-control" id="lastName${i}" placeholder="여권에 표시된 영문 성 입력">
                        </div>
                        <div class="mb-3">
                            <label for="birthDate${i}" class="form-label">생년월일</label>
                            <input type="date" class="form-control" id="birthDate${i}" placeholder="생년월일">
                        </div>
                        <div class="mb-3">
                            <label for="phone${i}" class="form-label">전화번호</label>
                            <input type="tel" class="form-control" id="phone${i}" placeholder="전화번호">
                        </div>
                        <div class="mb-3">
                            <label for="passport${i}" class="form-label">여권번호</label>
                            <input type="tel" class="form-control" id="passport${i}" placeholder="여권번호">
                        </div>
                    </form>
                </div>
            </div>
            `;
            container.appendChild(div);
        }
      });
        const reserveButton = document.querySelector('.btn-primary');

        reserveButton.addEventListener('click', function() {
            const flightId = document.getElementById('id').value;
            const Total_price = document.getElementById('price').value;
            const mainFirstName = document.getElementById('FirstName').value; // 예매자의 영문 이름
            const mainLastName = document.getElementById('LastName').value; // 예매자의 영문 성
        
            let passengers = [];

            // 동적으로 생성된 모든 승객 정보 수집
            const passengerCount = parseInt(getQueryVariable('passengers'), 10);
            for (let i = 1; i <= passengerCount; i++) {
                passengers.push({
                    firstName: document.getElementById(`firstName${i}`).value,
                    lastName: document.getElementById(`lastName${i}`).value,
                    birthDate: document.getElementById(`birthDate${i}`).value,
                    phone: document.getElementById(`phone${i}`).value,
                    passport: document.getElementById(`passport${i}`).value
                });
            }

            // POST 요청 데이터 설정
            const postData = {
                flight_id: flightId,
                price : Total_price,
                passengers: passengers,
                firstName : mainFirstName,
                lastName : mainLastName
            };
            console.log(postData);
            // 예약 완료 요청 보내기
            fetch('/backend/reservation_api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                  $('#successModal').modal('show');
                  const confirmBtn = document.getElementById('confirmBtn');
                  confirmBtn.addEventListener('click', () => {
                      window.location.href = `/payment_info?reservationId=${data.reservation_id}`;
                  });
                } else {
                    alert('예약 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('서버 에러가 발생했습니다.');
            });
        });

    function checkSession() {
            return fetch('/backend/check_session.php')
                .then(response => response.json())
                .then(data => {
                    const authButtons = document.getElementById('authButtons');
                    if (data.loggedIn) {
                        authButtons.innerHTML = `
                            <a href="/logout" class="btn btn-outline-primary-custom me-2" id="logoutButton">로그아웃</a>
                            <a href="/profile" class="btn btn-outline-primary-custom me-2" id="profileButton">나의 정보</a>
                        `;
                        return true;
                    }
                    else{
                      return false;
                    }
                })
                .catch(error => {
                  console.error('Error checking session:', error)
                  return false;
                });
        }

    document.addEventListener("DOMContentLoaded", function() {
        fetch('/backend/user_api.php')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                document.getElementById('FirstName').value = data.user.FirstName;
                document.getElementById('LastName').value = data.user.LastName;
                document.getElementById('email').value = data.user.email;
                document.getElementById('phone').value = data.user.phone;
            } else {
                console.error('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Fetch error:', error));
    });
    </script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>  
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </body>
</html>